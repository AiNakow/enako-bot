<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥åº·éº»å°†è”åˆ - æ•°æ®é¢„è§ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #f0f2f5;
            font-family: "Microsoft YaHei", sans-serif;
        }
        .card {
            background: white;
            border-radius: 0.75rem;
            transition: transform 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        canvas {
            min-height: 250px;
            width: 100% !important;
        }
        .font-mono {
            letter-spacing: -0.05em;
            color: #1e40af;
        }
        .badge {
            padding: 0.5em 1em;
            border-radius: 9999px;
            font-weight: 500;
        }
        .text-2xl.font-bold.text-[#1e40af] {
            font-family: "DIN Alternate", "Arial", sans-serif;
        }
        .text-4xl.font-bold {
            color: #1e40af;
            font-weight: 800;
        }
        .rank-divider {
            height: 2px;
            background-color: #94a3b8;
            margin: 4px auto;
        }
        @media (max-width: 768px) {
            canvas {
                min-height: 200px;
            }
            .text-4xl {
                font-size: 1.75rem;
            }
            .text-2xl {
                font-size: 1.25rem;
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-4">
        <!-- ç©å®¶ä¿¡æ¯ -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div class="card bg-base-100 shadow-xl p-4">
                <div class="flex items-center gap-4">
                    <img src="data:image/png;base64,{{ userpic }}" alt="Avatar" class="w-24 h-24 rounded-lg">
                    <div>
                        <h2 class="text-2xl font-bold text-[#1e40af]"></h2>
                        <div class="mt-2">
                            <p class="flex items-center gap-2">
                                <span class="text-yellow-500">ğŸ†</span>
                                <span>å…¨å›½æ’åï¼š</span>
                            </p>
                            <p class="flex items-center gap-2">
                                <span class="text-red-500">ğŸ…</span>
                                <span>é›€åº„æ’åï¼š</span>
                            </p>
                            <p class="flex items-center gap-2">
                                <span class="text-blue-500">ğŸ®</span>
                                <span>æ€»å±€æ•°ï¼š</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card bg-base-100 shadow-xl p-4">
                <h3 class="text-lg font-bold mb-4"></h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-[#1e40af]"></div>
                        <div class="text-sm">æœ€é«˜ç‚¹æ•°</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-[#1e40af]"></div>
                        <div class="text-sm">å¹³å‡ç‚¹æ•°</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-[#1e40af]"></div>
                        <div class="text-sm">å½“å‰å‡é¡º</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-[#1e40af]"></div>
                        <div class="text-sm">é¡ºä½ä¹‹å’Œ</div>
                    </div>
                </div>
            </div>

            <div class="card bg-base-100 shadow-xl p-4 flex items-center justify-center">
                <div class="text-center">
                    <div class="text-4xl font-bold text-[#1e40af] mb-2"></div>
                    <div class="text-xl"></div>
                </div>
            </div>
        </div>

        <!-- é¡ºä½æ•°æ® -->
        <div class="card bg-base-100 shadow-xl p-4 mb-4">
            <h3 class="text-lg font-bold mb-2 text-center">æœ€è¿‘é¡ºä½æ•°æ®ï¼ˆæ—§ â†’ æ–°ï¼‰</h3>
            <div id="rankGroups" class="flex flex-wrap gap-4 mb-4 justify-center">
                <!-- åœºæ¬¡åˆ†ç»„å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
            </div>
            <div class="bg-[#1e40af] text-white p-4 rounded-lg">
                <div class="w-fit mx-auto">
                    <p class="text-left">ğŸ”¹ å½“å‰æœ€å¿«çš„å‡æ®µæ¡ä»¶æ˜¯ åŠåº„é¡ºä½ä¹‹å’Œ â‰¤ </p>
                    <p class="text-left">ğŸ”¹ å½“å‰æœ€å®½æ¾å‡æ®µæ¡ä»¶æ˜¯ åŠåº„é¡ºä½ä¹‹å’Œ â‰¤ </p>
                </div>
            </div>
        </div>

        <!-- å›¾è¡¨åŒºåŸŸ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="card bg-base-100 shadow-xl p-4">
                <h3 class="text-lg font-bold mb-4"></h3>
                <canvas id="radarChart"></canvas>
            </div>
            <div class="card bg-base-100 shadow-xl p-4">
                <h3 class="text-lg font-bold mb-4"></h3>
                <canvas id="doughnutChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // APIæ¥å£
        const API_ENDPOINTS = {
            basic: 'https://gsz.rmlinking.com/gszapi/customer/getCustomerByName',
            tech: 'https://gsz.rmlinking.com/gszapi/score/tech',
            rateList: 'https://gsz.rmlinking.com/gszapi/customer/getCustomerRateList'
        };

        // æ•°æ®è·å–å‡½æ•°
        function fetchData(playerName = '{{ username }}') {
            /*
            try {
                // è·å–åŸºæœ¬ä¿¡æ¯
                const basicResponse = await fetch(`${API_ENDPOINTS.basic}?name=${encodeURIComponent(playerName)}`);
                const basicResult = await basicResponse.json();
                
                if (basicResult.code !== 200) {
                    throw new Error(basicResult.message || 'åŸºç¡€æ•°æ®è·å–å¤±è´¥');
                }

                const basicData = basicResult.data;

                // è·å–æŠ€æœ¯æ•°æ®
                const techResponse = await fetch(`${API_ENDPOINTS.tech}?customerId=${basicData.id}`);
                const techResult = await techResponse.json();

                if (techResult.code !== 200) {
                    throw new Error(techResult.message || 'æŠ€æœ¯æ•°æ®è·å–å¤±è´¥');
                }

                const techData = techResult.data;

                // è·å–æœ€è¿‘å¯¹å±€æ•°æ®
                const rateListResponse = await fetch(`${API_ENDPOINTS.rateList}?customerId=${basicData.id}`);
                const rateListResult = await rateListResponse.json();

                if (rateListResult.code !== 200) {
                    throw new Error(rateListResult.message || 'å¯¹å±€æ•°æ®è·å–å¤±è´¥');
                }

            } catch (error) {
                console.error('APIè¯·æ±‚å¤±è´¥:', error);
                throw error;
            }
            */

            const basicData = JSON.parse('{{ basic_data }}')
            const techData = JSON.parse('{{ tech_data }}')
            const rateListData = JSON.parse('{{ rateList_data }}')

            return {
                    basicData,
                    techData,
                    rateListData
                };
        }

        // æ›´æ–°ç©å®¶ä¿¡æ¯
        function updatePlayerInfo(data, rateListData) {
            // æ›´æ–°å¤´åƒ
            //const avatarUrl = `https://q.qlogo.cn/headimg_dl?dst_uin=${data.qq}&spec=640&img_type=jpg`;
            // document.querySelector('.flex.items-center.gap-4 img').src = avatarUrl;

            // ä½¿ç”¨æ›´ç²¾ç¡®çš„é€‰æ‹©å™¨
            document.querySelector('.card .flex.items-center.gap-4 h2').textContent = data.name;
            document.querySelector('p:has(.text-yellow-500) span:last-child').textContent = `å…¨å›½æ’åï¼š${data.allRankNum}`;
            document.querySelector('p:has(.text-red-500) span:last-child').textContent = `é›€åº„æ’åï¼š${data.rateRankNum}`;
            document.querySelector('p:has(.text-blue-500) span:last-child').textContent = `æ€»å±€æ•°ï¼š${data.totalRate}`;
            
            // æ›´æ–°æ®µä½ä¿¡æ¯
            document.querySelector('.card .text-center .text-4xl.font-bold').textContent = data.rankRule.rank;
            document.querySelector('.card .text-center .text-xl').textContent = `RATE #${data.rate}`;

            // æ›´æ–°æ•°æ®é¢„è§ˆ
            const previewCard = document.querySelector('.card:has(h3)');
            const statElements = previewCard.querySelectorAll('.text-2xl.font-bold.text-\\[\\#1e40af\\]');
            statElements[0].textContent = data.maxPoint;
            statElements[1].textContent = data.avgPoint;

            
            // æ›´æ–°å‡æ®µæ¡ä»¶
            const conditionDiv = document.querySelector('.bg-\\[\\#1e40af\\]');
            const conditionElements = conditionDiv.querySelectorAll('p');

            if (data.rankRule.round === null){
                statElements[2].textContent = "å·²é€šå…³";
                statElements[3].textContent = "å·²é€šå…³";
                const fastestConditionText = `ğŸ”¹ å½“å‰æœ€å¿«çš„å‡æ®µæ¡ä»¶æ˜¯ï¼šæ­å–œä½ æˆåŠŸé€šå…³ï¼`;
                const relaxedConditionText = `ğŸ”¹ å½“å‰æœ€å®½æ¾å‡æ®µæ¡ä»¶æ˜¯ï¼šæ­å–œä½ æˆåŠŸé€šå…³ï¼`;
                
                conditionElements[0].textContent = fastestConditionText;
                conditionElements[1].textContent = relaxedConditionText;
            }
            else {
                const avgPositionElement = statElements[2];
                avgPositionElement.textContent = data.upAvgPosition.toFixed(2);
                avgPositionElement.insertAdjacentHTML('afterend', 
                    `<div class="text-xs text-gray-500">ï¼ˆâ‰¤${data.rankRule.avg}ï¼‰å¯å‡æ®µ</div>`
                );
                const sumPositionElement = statElements[3];
                sumPositionElement.textContent = data.sumPosition;
                sumPositionElement.insertAdjacentHTML('afterend', 
                    `<div class="text-xs text-gray-500">ï¼ˆâ‰¤${data.rankRule.value}ï¼‰å¯å‡æ®µ</div>`
                );

                // è·å–æœ€è¿‘çš„å¯¹å±€é¡ºä½æ•°æ®
                const recentGames = rateListData
                    .sort((a, b) => new Date(a.createTime) - new Date(b.createTime))
                    .map(game => parseInt(game.sort));

                const requiredGames = data.rankRule.round; // éœ€è¦çš„æ€»å±€æ•°
                const maxAllowedSum = data.rankRule.value; // å…è®¸çš„æœ€å¤§é¡ºä½å’Œ
                const avgPosition = parseFloat(data.rankRule.avg); // å¹³å‡é¡ºä½è¦æ±‚

                let neededGames = 0, targetSum;

                const latestGames = recentGames.slice(-requiredGames);
                let currentSum = latestGames.reduce((sum, pos) => sum + pos, 0);
                let oldCurrentSum = currentSum;
                // å¦‚æœå±€æ•°ä¸è¶³
                if (recentGames.length < requiredGames) {
                    // è®¡ç®—éœ€è¦å¡«å……çš„å±€æ•°
                    const remainingGames = requiredGames - recentGames.length;
                    // å¡«å……æ‰€æœ‰å‰©ä½™å±€æ•°ä¸º1ä½
                    currentSum = currentSum + remainingGames;
                    
                    neededGames = remainingGames;
                }
                // è·å–æœ€è¿‘requiredGameså±€çš„é¡ºä½æ•°æ®

                // æ£€æŸ¥æ˜¯å¦å·²ç»æ»¡è¶³å‡æ®µæ¡ä»¶
                if (currentSum <= maxAllowedSum) {
                    targetSum = maxAllowedSum - oldCurrentSum;
                } else {
                    // ä»æœ€è€çš„ä¸€å±€å¼€å§‹å°è¯•æ›¿æ¢ä¸º1ä½
                    let replacedCount = 0;
                    let tempSum = currentSum;
                    
                    for (let i = 0; i < latestGames.length; i++) {
                        // è®¡ç®—æ›¿æ¢è¿™ä¸€å±€ä¸º1ä½åçš„é¡ºä½å’Œ
                        tempSum = tempSum - latestGames[i] + 1;
                        replacedCount++;
                        
                        if (tempSum <= maxAllowedSum) {
                            // æ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„æƒ…å†µ
                            neededGames += replacedCount;
                            targetSum = neededGames + (maxAllowedSum - tempSum);
                            break;
                        }
                    }
                }

                // è®¡ç®—æœ€å®½æ¾å‡æ®µæ¡ä»¶
                let relaxedNeededGames = 0, relaxedTargetSum;
                
                // è·å–æœ€è¿‘requiredGameså±€çš„é¡ºä½æ•°æ®
                currentSum = latestGames.reduce((sum, pos) => sum + pos, 0);
                oldCurrentSum = currentSum;
                if (recentGames.length < requiredGames) {
                    // å¦‚æœè¿˜æœªæ»¡è¶³å±€æ•°è¦æ±‚
                    const remainingGames = requiredGames - recentGames.length;
                    // å¡«å……æ‰€æœ‰å‰©ä½™å±€æ•°ä¸ºavgPosition
                    currentSum = currentSum + (remainingGames * avgPosition);
                    relaxedNeededGames = remainingGames;
                }

                // æ£€æŸ¥æ˜¯å¦å·²ç»æ»¡è¶³å‡æ®µæ¡ä»¶
                if (currentSum <= maxAllowedSum) {
                    relaxedTargetSum = maxAllowedSum - oldCurrentSum;
                } else {
                    let replacedCount = 0;
                    let tempSum = currentSum;
                    let bestAvgPosition = 1;
                    let bestNeededGames = 0;
                    for (let i = 0; i < latestGames.length; i++) {
                        tempSum = tempSum - latestGames[i];
                        replacedCount++;
                        if (tempSum <= maxAllowedSum && (maxAllowedSum - tempSum) / replacedCount > bestAvgPosition) {
                            bestAvgPosition = (maxAllowedSum - tempSum) / replacedCount;
                            bestNeededGames = replacedCount;
                        }
                    }
                    
                    relaxedTargetSum = Math.ceil(relaxedNeededGames * bestAvgPosition + bestNeededGames * bestAvgPosition);
                    relaxedNeededGames += bestNeededGames;
                /*
                    // ä»æœ€è€çš„ä¸€å±€å¼€å§‹å°è¯•æ›¿æ¢ä¸ºavgPosition
                    let replacedCount = 0;
                    let tempSum = currentSum;
                    
                    for (let i = 0; i < latestGames.length; i++) {
                        // è®¡ç®—æ›¿æ¢è¿™ä¸€å±€ä¸ºavgPositionåçš„é¡ºä½å’Œ
                        tempSum = tempSum - latestGames[i] + avgPosition;
                        replacedCount++;
                        
                        if (tempSum <= maxAllowedSum) {
                            // æ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„æƒ…å†µ
                            relaxedNeededGames += replacedCount;
                            // è®¡ç®—ç›®æ ‡é¡ºä½å’Œï¼šæ›¿æ¢çš„å±€æ•°*å¹³å‡é¡ºä½ + å‰©ä½™å¯ç”¨çš„é¡ºä½å’Œ
                            relaxedTargetSum = Math.ceil(relaxedNeededGames * avgPosition + (maxAllowedSum - tempSum));
                            break;
                        }
                    }
                */
                }

                const fastestConditionText = `ğŸ”¹ å½“å‰æœ€å¿«çš„å‡æ®µæ¡ä»¶æ˜¯ï¼š${neededGames}åŠåº„é¡ºä½ä¹‹å’Œ â‰¤ ${targetSum}`;
                const relaxedConditionText = `ğŸ”¹ å½“å‰æœ€å®½æ¾å‡æ®µæ¡ä»¶æ˜¯ï¼š${relaxedNeededGames}åŠåº„é¡ºä½ä¹‹å’Œ â‰¤ ${relaxedTargetSum}`;
                
                conditionElements[0].textContent = fastestConditionText;
                conditionElements[1].textContent = relaxedConditionText;
            }
        }

        // åˆå§‹åŒ–6ç»´å›¾
        function initRadarChart(techData) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            // å°†æ•°æ®æ ‡å‡†åŒ–åˆ°0-100èŒƒå›´
            const normalizeValue = (value, max = 1) => Math.min(100, Math.max(0, (value / max) * 100));
            
            const normalizedData = [
                normalizeValue(techData.fire - 40000, 6000),    // ç«åŠ›
                normalizeValue(techData.defense, 0.9),        // é˜²å®ˆ
                normalizeValue(techData.stabilize, 0.6),      // ç¨³å®š
                normalizeValue(techData.lucky, 3),       // è¿åŠ¿
                normalizeValue(techData.tech - 1500, 400),     // æŠ€æœ¯
                normalizeValue(techData.attack, 0.3)          // è¿›æ”»
            ];

            return new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['ç«åŠ›', 'é˜²å®ˆ', 'ç¨³å®š', 'è¿åŠ¿', 'æŠ€æœ¯', 'è¿›æ”»'],
                    datasets: [{
                        label: 'èƒ½åŠ›å€¼',
                        data: normalizedData,
                        backgroundColor: 'rgba(30, 64, 175, 0.2)',
                        borderColor: 'rgba(30, 64, 175, 0.8)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(30, 64, 175, 1)',
                    }]
                },
                options: {
                    animation: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                display: false
                            },
                            grid: {
                                color: 'rgba(30, 64, 175, 0.2)'
                            },
                            angleLines: {
                                color: 'rgba(30, 64, 175, 0.2)'
                            },
                            pointLabels: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // åˆå§‹åŒ–ç¯å½¢å›¾
        function initDoughnutChart(techData) {
            const ctx = document.getElementById('doughnutChart').getContext('2d');
            const data = [
                techData.ratio1 * 100,
                techData.ratio2 * 100,
                techData.ratio3 * 100,
                techData.ratio4 * 100
            ];

            return new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['ä¸€ä½', 'äºŒä½', 'ä¸‰ä½', 'å››ä½'],
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            'rgb(59, 130, 246)',  // æ›´æ·±çš„è“è‰²
                            'rgb(163, 230, 53)',  // ä¿æŒç»¿è‰²ä¸å˜
                            'rgb(250, 204, 21)',  // ä¿æŒé»„è‰²ä¸å˜
                            'rgb(248, 113, 113)'  // ä¿æŒçº¢è‰²ä¸å˜
                        ],
                        borderWidth: 2,
                        borderColor: 'white'
                    }]
                },
                options: {
                    animation: false,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 14
                                },
                                usePointStyle: true,
                                pointStyle: 'circle',
                                borderWidth: 0,
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    return data.labels.map((label, i) => ({
                                        text: `${label} - ${data.datasets[0].data[i].toFixed(2)}%`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        index: i
                                    }));
                                }
                            }
                        }
                    }
                }
            });
        }

        // æ›´æ–°é¡ºä½æ•°æ®
        function updateRankHistory(rateListData) {
            const rankGroupsElement = document.getElementById('rankGroups');
            
            // å¤„ç†æœ€è¿‘é¡ºä½æ•°æ®
            const recentRanks = rateListData
                .sort((a, b) => new Date(a.createTime) - new Date(b.createTime)) // æŒ‰æ—¶é—´å‡åºæ’åº
                .map(game => game.sort) // æå–é¡ºä½
                .join('');
            
            // å°†é¡ºä½æ•°æ®åˆ†ç»„ï¼ˆæ¯5ä¸ªä¸€ç»„ï¼‰
            const ranks = recentRanks.match(/.{1,5}/g) || [];
            let html = '';
            
            ranks.forEach((group, index) => {
                const startGame = index * 5 + 1;
                const endGame = startGame + group.length - 1;
                html += `
                    <div class="text-center">
                        <div class="text-sm text-gray-500">${startGame}-${endGame}</div>
                        <div class="rank-divider" style="width: ${group.length}ch;"></div>
                        <div class="text-lg font-mono">${group}</div>
                    </div>
                `;
            });
            
            rankGroupsElement.innerHTML = html;
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const data = fetchData();
                updatePlayerInfo(data.basicData, data.rateListData);
                initRadarChart(data.techData);
                initDoughnutChart(data.techData);
                updateRankHistory(data.rateListData);
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
               // alert('æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        });
    </script>
</body>
</html> 